//@version=6
indicator('God & Devils Strategy ðŸ˜‡ ðŸ˜ˆ', overlay=true)

// ========== Ð¤Ð ÐÐšÐ¢ÐÐ›Ð« ==========
var GRP1 = "â€¢â€¢â€¢â€¢â€¢â€¢â€¢ FRACTALS â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
showFractals = input.bool(true, title='Show fractal points?', group=GRP1)

isBWFractal(mode, n) =>
    ret = mode == 'Buy' ? high[n - 2] < high[n] and high[n - 1] < high[n] and high[n + 1] < high[n] and high[n + 2] < high[n] : mode == 'Sell' ? low[n - 2] > low[n] and low[n - 1] > low[n] and low[n + 1] > low[n] and low[n + 2] > low[n] : false

isFractalHigh(i) => isBWFractal('Buy', i + 1)
isFractalLow(i) => isBWFractal('Sell', i + 1)

plotshape(showFractals and isFractalHigh(1), title='Fractal High', style=shape.triangledown, location=location.abovebar, color=color.red, offset=-2, size=size.auto)
plotshape(showFractals and isFractalLow(1), title='Fractal Low', style=shape.triangleup, location=location.belowbar, color=color.lime, offset=-2, size=size.auto)

// ========== Ð›Ð˜ÐÐ˜Ð˜ Ð›Ð˜ÐšÐ’Ð˜Ð”ÐÐžÐ¡Ð¢Ð˜ ==========
var GRP2 = "â€¢â€¢â€¢â€¢â€¢â€¢â€¢ LIQUIDITY LINES â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
showLines = input.bool(true, title='Show liquidity lines?', group=GRP2)
liqLineWidth = input.int(2, title="Line Width", minval=1, maxval=10, group=GRP2)
liqLineBars = input.int(20, title="Line Length (bars)", minval=5, maxval=100, group=GRP2)

liqPivotHigh = ta.pivothigh(4, 4)
liqPivotLow = ta.pivotlow(4, 4)

// Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ ÑƒÑ€Ð¾Ð²Ð½Ð¸ Ð»Ð¸Ð½Ð¸Ð¹ Ð»Ð¸ÐºÐ²Ð¸Ð´Ð½Ð¾ÑÑ‚Ð¸
var float activeHighLine = na
var float activeLowLine = na

if showLines and not na(liqPivotHigh)
    liqLineEnd = time[4] + (time[1] - time[2]) * liqLineBars
    line.new(time[4], high[4], liqLineEnd, high[4], color=color.blue, width=liqLineWidth, xloc=xloc.bar_time)
    activeHighLine := high[4]

if showLines and not na(liqPivotLow)
    liqLineEnd = time[4] + (time[1] - time[2]) * liqLineBars
    line.new(time[4], low[4], liqLineEnd, low[4], color=color.red, width=liqLineWidth, xloc=xloc.bar_time)
    activeLowLine := low[4]

// ========== MACD Ð˜ Ð¦Ð’Ð•Ð¢Ð Ð‘ÐÐ ÐžÐ’ ==========
var GRP3 = "â€¢â€¢â€¢â€¢â€¢â€¢â€¢ MACD COLORS â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
macdSource = input(high, title="Source", group=GRP3)
macdFastLength = input.int(7, minval=1, title="MACD fast moving average", group=GRP3)
macdSlowLength = input.int(7, minval=1, title="MACD slow moving average", group=GRP3)
macdSignalLength = input.int(7, minval=1, title="MACD signal line moving average", group=GRP3)
macdVeryslowLength = input.int(7, minval=1, title="Very slow moving average", group=GRP3)
switch1 = input.bool(true, title="Enable Bar Color?", group=GRP3)
switch2 = input.bool(true, title="Enable Moving Averages?", group=GRP3)
switch3 = input.bool(true, title="Enable Background Color?", group=GRP3)
switch4 = input.bool(true, title="Enable Blue Bar Alerts?", group=GRP3)

// Calculation
fastMA = ta.sma(macdSource, macdFastLength)
slowMA = ta.sma(macdSource, macdSlowLength)
veryslowMA = ta.sma(macdSource, macdVeryslowLength)
macd = fastMA - slowMA
signal = ta.sma(macd, macdSignalLength)
hist = macd - signal

// Colors
MAtrendcolor = ta.change(veryslowMA) > 0 ? color.green : color.red
trendcolor = fastMA > slowMA and ta.change(veryslowMA) > 0 and close > slowMA ? color.green : fastMA < slowMA and ta.change(veryslowMA) < 0 and close < slowMA ? color.red : color.blue
bartrendcolor = close > fastMA and close > slowMA and close > veryslowMA and ta.change(slowMA) > 0 ? color.green : close < fastMA and close < slowMA and close < veryslowMA and ta.change(slowMA) < 0 ? color.red : color.blue
backgroundcolor = slowMA > veryslowMA and ta.crossover(hist, 0) and macd > 0 and fastMA > slowMA and close[macdSlowLength] > veryslowMA ? color.new(color.green, 80) : slowMA < veryslowMA and ta.crossunder(hist, 0) and macd < 0 and fastMA < slowMA and close[macdSlowLength] < veryslowMA ? color.new(color.red, 80) : na

bgcolor(switch3 ? backgroundcolor : na)
barcolor(switch1 ? bartrendcolor : na)

// Blue Bar Alert
isBlueBar = bartrendcolor == color.blue
isNewBlueBar = isBlueBar and bartrendcolor[1] != color.blue

if switch4 and isNewBlueBar
    alert("ðŸ”µ Blue Bar Detected!", alert.freq_once_per_bar)

// Moving Averages
F = plot(switch2 ? fastMA : na, color=trendcolor, title="Fast MA")
S = plot(switch2 ? slowMA : na, color=trendcolor, linewidth=2, title="Slow MA")
V = plot(switch2 ? veryslowMA : na, color=MAtrendcolor, linewidth=4, title="Very Slow MA")
fill(F, V, color=color.new(color.gray, 90))

// ========== Ð¢ÐžÐ Ð“ÐžÐ’Ð«Ð• Ð¡Ð˜Ð“ÐÐÐ›Ð« ==========
var GRP4 = "â€¢â€¢â€¢â€¢â€¢â€¢â€¢ TRADE SIGNALS â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
enableSignals = input.bool(true, title="Enable Trade Signals?", group=GRP4)

// ========== ÐÐÐ¡Ð¢Ð ÐžÐ™ÐšÐ˜ Ð¡Ð•Ð¡Ð¡Ð˜Ð™ ==========
var GRP5 = "â€¢â€¢â€¢â€¢â€¢â€¢â€¢ TRADING SESSIONS â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
enableSessions = input.bool(true, title="Enable Session Filter?", group=GRP5)
londonStart = input.int(10, title="London Start Hour", minval=0, maxval=23, group=GRP5)
londonEnd = input.int(15, title="London End Hour", minval=0, maxval=23, group=GRP5)
nyStart = input.int(15, title="New York Start Hour", minval=0, maxval=23, group=GRP5)
nyEnd = input.int(22, title="New York End Hour", minval=0, maxval=23, group=GRP5)

// ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ðµ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ñ… ÑÐµÑÑÐ¸Ð¹
currentHour = hour(time, "GMT+3")  // GMT+3 Ð¿Ð¾ÑÑ
isLondonSession = currentHour >= londonStart and currentHour < londonEnd
isNySession = currentHour >= nyStart and currentHour < nyEnd
isTradeSession = isLondonSession or isNySession

// ÐŸÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð´Ð»Ñ Ð¾Ñ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°Ð½Ð¸Ñ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð° ÑÐ¸Ð³Ð½Ð°Ð»Ð¾Ð² Ð² ÑÐµÑÑÐ¸ÑÑ…  
var int londonSignalCount = 0
var int nySignalCount = 0
maxSignalsPerSession = 3

// Ð¡Ð±Ñ€Ð¾Ñ ÑÑ‡ÐµÑ‚Ñ‡Ð¸ÐºÐ¾Ð² Ð¿Ñ€Ð¸ ÑÐ¼ÐµÐ½Ðµ Ð´Ð½ÐµÐ¹
if ta.change(dayofweek) != 0
    londonSignalCount := 0
    nySignalCount := 0

// Ð¡Ð±Ñ€Ð¾Ñ ÑÑ‡ÐµÑ‚Ñ‡Ð¸ÐºÐ¾Ð² Ð¿Ñ€Ð¸ Ð½Ð°Ñ‡Ð°Ð»Ðµ Ð½Ð¾Ð²Ñ‹Ñ… ÑÐµÑÑÐ¸Ð¹
if isLondonSession and not isLondonSession[1]  // Ð½Ð°Ñ‡Ð°Ð»Ð¾ Ð»Ð¾Ð½Ð´Ð¾Ð½ÑÐºÐ¾Ð¹ ÑÐµÑÑÐ¸Ð¸
    londonSignalCount := 0
if isNySession and not isNySession[1]  // Ð½Ð°Ñ‡Ð°Ð»Ð¾ Ð½ÑŒÑŽ-Ð¹Ð¾Ñ€ÐºÑÐºÐ¾Ð¹ ÑÐµÑÑÐ¸Ð¸  
    nySignalCount := 0

// ÐŸÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ - Ð¡Ð¢Ð ÐžÐ“Ð˜Ð™ ÐÐ›Ð“ÐžÐ Ð˜Ð¢Ðœ
var bool lineBreakConfirmed_HIGH = false  // ÐŸÐ¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¾ Ð·Ð°ÐºÑ€ÐµÐ¿Ð»ÐµÐ½Ð¸Ðµ Ð½Ð¸Ð¶Ðµ Ð²ÐµÑ€Ñ…Ð½ÐµÐ¹ Ð»Ð¸Ð½Ð¸Ð¸
var bool lineBreakConfirmed_LOW = false   // ÐŸÐ¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¾ Ð·Ð°ÐºÑ€ÐµÐ¿Ð»ÐµÐ½Ð¸Ðµ Ð²Ñ‹ÑˆÐµ Ð½Ð¸Ð¶Ð½ÐµÐ¹ Ð»Ð¸Ð½Ð¸Ð¸

if enableSignals
    // Ð­Ð¢ÐÐŸ 1: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿ÐµÑ€ÐµÑÐµÑ‡ÐµÐ½Ð¸Ñ Ð¸ Ð—ÐÐšÐ Ð•ÐŸÐ›Ð•ÐÐ˜Ð¯
    
    // Ð¡Ð±Ñ€Ð¾Ñ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ð¹ Ð¿Ñ€Ð¸ Ð½Ð¾Ð²Ñ‹Ñ… Ð»Ð¸Ð½Ð¸ÑÑ… Ð»Ð¸ÐºÐ²Ð¸Ð´Ð½Ð¾ÑÑ‚Ð¸
    if not na(liqPivotHigh)
        lineBreakConfirmed_HIGH := false
        lineBreakConfirmed_LOW := false
    if not na(liqPivotLow)  
        lineBreakConfirmed_LOW := false
        lineBreakConfirmed_HIGH := false
    
    // Ð—ÐÐšÐ Ð•ÐŸÐ›Ð•ÐÐ˜Ð• ÐÐ˜Ð–Ð• Ð²ÐµÑ€Ñ…Ð½ÐµÐ¹ Ð»Ð¸Ð½Ð¸Ð¸ (Ð´Ð»Ñ SHORT)
    if not na(activeHighLine) and not lineBreakConfirmed_HIGH
        // Ð£ÑÐ»Ð¾Ð²Ð¸Ðµ: ÑÐ²ÐµÑ‡Ð° Ð¿ÐµÑ€ÐµÑÐµÐºÐ»Ð° Ð¸ Ð—ÐÐšÐ Ð«Ð›ÐÐ¡Ð¬ Ð½Ð¸Ð¶Ðµ Ð»Ð¸Ð½Ð¸Ð¸
        if close < activeHighLine and high >= activeHighLine
            lineBreakConfirmed_HIGH := true
            lineBreakConfirmed_LOW := false  // ÑÐ±Ñ€Ð¾Ñ Ð¿Ñ€Ð¾Ñ‚Ð¸Ð²Ð¾Ð¿Ð¾Ð»Ð¾Ð¶Ð½Ð¾Ð³Ð¾
    
    // Ð—ÐÐšÐ Ð•ÐŸÐ›Ð•ÐÐ˜Ð• Ð’Ð«Ð¨Ð• Ð½Ð¸Ð¶Ð½ÐµÐ¹ Ð»Ð¸Ð½Ð¸Ð¸ (Ð´Ð»Ñ LONG)
    if not na(activeLowLine) and not lineBreakConfirmed_LOW
        // Ð£ÑÐ»Ð¾Ð²Ð¸Ðµ: ÑÐ²ÐµÑ‡Ð° Ð¿ÐµÑ€ÐµÑÐµÐºÐ»Ð° Ð¸ Ð—ÐÐšÐ Ð«Ð›ÐÐ¡Ð¬ Ð²Ñ‹ÑˆÐµ Ð»Ð¸Ð½Ð¸Ð¸  
        if close > activeLowLine and low <= activeLowLine
            lineBreakConfirmed_LOW := true
            lineBreakConfirmed_HIGH := false  // ÑÐ±Ñ€Ð¾Ñ Ð¿Ñ€Ð¾Ñ‚Ð¸Ð²Ð¾Ð¿Ð¾Ð»Ð¾Ð¶Ð½Ð¾Ð³Ð¾

// Ð­Ð¢ÐÐŸ 2: Ð‘Ð°Ð·Ð¾Ð²Ñ‹Ðµ ÑÐ¸Ð³Ð½Ð°Ð»Ñ‹ (Ð±ÐµÐ· Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ð° ÑÐµÑÑÐ¸Ð¹)
baseShortSignal = enableSignals and lineBreakConfirmed_HIGH and bartrendcolor == color.blue and bartrendcolor[1] != color.blue
baseLongSignal = enableSignals and lineBreakConfirmed_LOW and bartrendcolor == color.blue and bartrendcolor[1] != color.blue

// Ð­Ð¢ÐÐŸ 3: ÐŸÑ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ð° ÑÐµÑÑÐ¸Ð¹ Ð¸ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿ÐµÑ€Ð²Ð¾Ð³Ð¾ ÑÐ¸Ð³Ð½Ð°Ð»Ð°
shortSignal = false
longSignal = false

if enableSessions
    // Ð¤Ð¸Ð»ÑŒÑ‚Ñ€ ÑÐµÑÑÐ¸Ð¹: ÑÐ¸Ð³Ð½Ð°Ð»Ñ‹ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð²Ð¾ Ð²Ñ€ÐµÐ¼Ñ Ñ‚Ð¾Ñ€Ð³Ð¾Ð²Ñ‹Ñ… ÑÐµÑÑÐ¸Ð¹
    if baseShortSignal and isTradeSession
        if isLondonSession and londonSignalCount < maxSignalsPerSession
            shortSignal := true
            londonSignalCount := londonSignalCount + 1
        else if isNySession and nySignalCount < maxSignalsPerSession
            shortSignal := true
            nySignalCount := nySignalCount + 1

    if baseLongSignal and isTradeSession
        if isLondonSession and londonSignalCount < maxSignalsPerSession
            longSignal := true
            londonSignalCount := londonSignalCount + 1
        else if isNySession and nySignalCount < maxSignalsPerSession
            longSignal := true
            nySignalCount := nySignalCount + 1
else
    // Ð‘ÐµÐ· Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ð° ÑÐµÑÑÐ¸Ð¹ - Ð¾Ð±Ñ‹Ñ‡Ð½Ñ‹Ðµ ÑÐ¸Ð³Ð½Ð°Ð»Ñ‹
    shortSignal := baseShortSignal
    longSignal := baseLongSignal

// Ð­Ð¢ÐÐŸ 4: Ð¡Ð±Ñ€Ð¾Ñ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ Ð¢ÐžÐ›Ð¬ÐšÐž Ð¿Ð¾ÑÐ»Ðµ ÑÐ¸Ð³Ð½Ð°Ð»Ð° Ð¸Ð»Ð¸ Ð½Ð°Ñ€ÑƒÑˆÐµÐ½Ð¸Ñ Ð°Ð»Ð³Ð¾Ñ€Ð¸Ñ‚Ð¼Ð°
if shortSignal
    lineBreakConfirmed_HIGH := false
    
if longSignal
    lineBreakConfirmed_LOW := false

// Ð¡Ð±Ñ€Ð¾Ñ Ð¿Ñ€Ð¸ Ð½Ð°Ñ€ÑƒÑˆÐµÐ½Ð¸Ð¸ Ð°Ð»Ð³Ð¾Ñ€Ð¸Ñ‚Ð¼Ð° (ÐµÑÐ»Ð¸ Ð½Ðµ ÑÐ¸Ð½ÑÑ ÑÐ²ÐµÑ‡Ð° Ð¿Ð¾ÑÐ²Ð¸Ð»Ð°ÑÑŒ)
if lineBreakConfirmed_HIGH and bartrendcolor != color.blue and bartrendcolor[1] == color.blue
    lineBreakConfirmed_HIGH := false
    
if lineBreakConfirmed_LOW and bartrendcolor != color.blue and bartrendcolor[1] == color.blue  
    lineBreakConfirmed_LOW := false

// ÐÐ»ÐµÑ€Ñ‚Ñ‹
if shortSignal
    alert("ðŸ˜ˆ SHORT SIGNAL!", alert.freq_once_per_bar)
if longSignal
    alert("ðŸ˜‡ LONG SIGNAL!", alert.freq_once_per_bar)

// Ð’Ð¸Ð·ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ðµ ÑÐ¸Ð³Ð½Ð°Ð»Ñ‹
plotchar(longSignal, title='Long Signal', char='ðŸ˜‡', location=location.belowbar, color=color.green, size=size.small)
plotchar(shortSignal, title='Short Signal', char='ðŸ˜ˆ', location=location.abovebar, color=color.red, size=size.small)

// ÐžÐ¢Ð›ÐÐ”ÐšÐ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ð¹
plotchar(lineBreakConfirmed_HIGH, title='Waiting Short', char='S', location=location.abovebar, color=color.orange, size=size.tiny)
plotchar(lineBreakConfirmed_LOW, title='Waiting Long', char='L', location=location.belowbar, color=color.orange, size=size.tiny)

// ÐžÑ‚Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ… ÑÐµÑÑÐ¸Ð¹ (Ñ„Ð¾Ð½)
bgcolor(enableSessions and isLondonSession ? color.new(color.yellow, 95) : na, title="London Session")
bgcolor(enableSessions and isNySession ? color.new(color.blue, 95) : na, title="NY Session")